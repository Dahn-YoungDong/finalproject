---
title: "mapping"
author: "Dahn-Young Dong"
date: "11/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(raster)
library(rgdal)
library(rnaturalearth)
library(GISTools)
library(mapplots)
library(sp)

create_dir(c("./Results_Maps"))
```

#------------------------------------------------------------------------------
#                    1. Loading Files and Configuring Maps 
#------------------------------------------------------------------------------

```{r}
###1.2. LOAD VCF FILES, GEOGRAPHICAL INFORMATIONS AND ADMIXTURE COEFFICIENTS: 
#A. Load neutral .vcf file with geographical information and admixture and :
snps_neutral = vcfLink(paste0("vcf/", project_name, "_filtered_neutral_LEA_DAPC_TESS.vcf"), overwriteID=T)
VCFsummary(snps_neutral) #16 individuals and 100 SNPs.

#B. Create a data frame with the information on metafile
df = as.data.frame(snps_neutral@meta)
head(df)
tail(df)

#E. Create vectors with samples' position by population in TESS approach:
for (i in 1:length(unique(df$PopID_tess))){
  pop = which(df$PopID_tess == i)
  assign(paste0("pop_TESS_", i), pop)
}

```

```{r}
###1.3. DEFINE A EXTENSION FOR THE MAPS
#A. Calculate the range for the geographical coordinates:
long_extension = c(min(df$longitude), max(df$longitude))
lat_extension = c(min(df$latitude), max(df$latitude))
#verify the range of coordenates
long_extension
lat_extension

#B. Plot points for samples 
plot(snps_neutral@meta$longitude, snps_neutral@meta$latitude)

#C. Choose a extension for maps that cover all points. In this case:
ext = extent(-72.16100, -72.11800, 41.91700, 41.97200)

#D. Define the axes from maps
axis.x = c(-72.16100, -72.11800)
axis.y = c(41.91700, 41.97200)
```

###1.4. CREATING RASTER FOR THE BASE OF MAPS - HILLSHADE, SLOPE AND LANDCOVER
```{r eval=FALSE, include=FALSE}
#A. Load DEM raster (elevation raster):
#DEM = elevationLow <- readRDS("./maps/rasters/elevation.rds") ## extent didn't match so skip for now 
#DEM <- projectRaster(DEM, crs = landcover@crs)
#plot the map
#plot(DEM, col = gray.colors(20, start = 0, end = 1))
#crop according to study area
#DEM_base = crop(DEM, ext)

#temp <- raster::readAll(DEM_base)
#saveRDS(temp, file = "./maps/rasters/DEM_base.rds")

DEM_base <- readRDS("./maps/rasters/DEM_base.rds")
plot(DEM_base, col = gray.colors(20, start = 0, end = 1))
```

#------------------------------------------------------------------------------
#                           2. Mapping Genetic Clusters 
#------------------------------------------------------------------------------
```{r}
###2.3. MAPS USING TESS POPULATIONS
#A. Open pdf, choose the font letters, margins and axes.
pdf(paste0("./Results_Maps/Map_TESS_pops_", project_name, ".pdf"), family="Helvetica", onefile = F)
#set parameters
plot.new()
# Add margins
par(oma=c(2,2,2,2))
# Add axis
plot.window(xlim= axis.x, ylim= axis.y)
```

```{r}
#B. Plot maps for the base
plot(DEM_base, col = gray.colors(20, start = 0, end = 1))

#C. Plot lat and long axes:
#axis(1, at=seq(-72.16100, -72.11800, by=0.01))
#axis(2, at=seq(41.91700, 41.97200, by=0.01))

#D. Plot the points:
#set population names and colors. SAME THAN STEP 2!
col_tess= c("red","orange","yellow","green","blue","purple","black","grey","turquoise") 
legend_tess = c("POP1", "POP2", "POP3", "POP4", "POP5", "POP6","POP7","POP8","POP9")

#plot points. One line for each populations. Add or remove lines according to your necessity. #the code here is inconsistent, can't find pop_TESS_X
points(df$longitude[pop_TESS_1], df$latitude[pop_TESS_1], col = 'black', bg = col_tess[1], cex = 2.5, pch=21) #POP1
points(df$longitude[pop_TESS_2], df$latitude[pop_TESS_2], col = 'black', bg = col_tess[2], cex = 2.5, pch=21) #POP2
points(df$longitude[pop_TESS_3], df$latitude[pop_TESS_3], col = 'black', bg = col_tess[3], cex = 2.5, pch=21) #POP3
points(df$longitude[pop_TESS_4], df$latitude[pop_TESS_4], col = 'black', bg = col_tess[4], cex = 2.5, pch=21) #POP4
points(df$longitude[pop_TESS_5], df$latitude[pop_TESS_5], col = 'black', bg = col_tess[5], cex = 2.5, pch=21) #POP5
points(df$longitude[pop_TESS_6], df$latitude[pop_TESS_6], col = 'black', bg = col_tess[6], cex = 2.5, pch=21) #POP5
points(df$longitude[pop_TESS_7], df$latitude[pop_TESS_7], col = 'black', bg = col_tess[7], cex = 2.5, pch=21) #POP5
points(df$longitude[pop_TESS_8], df$latitude[pop_TESS_8], col = 'black', bg = col_tess[8], cex = 2.5, pch=21) #POP5
points(df$longitude[pop_TESS_9], df$latitude[pop_TESS_9], col = 'black', bg = col_tess[9], cex = 2.5, pch=21) #POP5
```

#E. Plot the names of Serras in Carajás or any area names according to shapefile information
posi_names_serra = which(!is.na(cangas$Serra2))
lon_names_serra = coordinates(cangas)[,1][posi_names_serra]
lat_names_serra = coordinates(cangas)[,2][posi_names_serra]
#plot names:
shadowtext((lon_names_serra-0.08), (lat_names_serra-0.025), cangas$Serra2[posi_names_serra], col="black", bg="white", cex=0.9, r=0.1)

#F. Plot the names of localities according to vcf information in metafile
localities = df$local_ID
for (i in 1:length(localities)){
  #pick the position of the first sample from that localities
  posi_local = which(df$local_ID %in% localities[i] == TRUE)[1]
  shadowtext((df$longitude[posi_local]+0.0), (df$latitude[posi_local]+0.0), localities[i], col="black", bg="white", cex=0.65, r=0.08, pos=4)
}

#G. Plot the legend:
legend(x=-49.85, y=-5.85, legend = legend_tess, cex = 0.8, bty="o", bg = "white", box.col="black",  col = "black", pt.bg = col_tess, pch= 21, pt.cex=1.5)

#H. Plot the scale bar:
scalebar(10, xy=c(-50.65,-6.47), type="bar", lonlat = T, below = "Km", label = c(0,5,10), adj=c(0,-1.5), cex = 0.7)

#I. Plot a north arrow:
north.arrow(xb=-49.8, yb=-6.45, len=0.015, cex.lab=0.8, lab="N", col='black', font.sub=1)

#J. Turn off pdf:
dev.off()

#------------------------------------------------------------------------------
#                     3. Mapping Ancestry Coefficients as Pie Chart
#------------------------------------------------------------------------------
```{r}
###3.2. MAPS USING TESS COEFFICIENTS
#A. Open pdf, choose the font letters, margins and axes.
pdf(paste0("./Results_Maps/Map_TESS_coeficients_", project_name, ".pdf"), family="Helvetica", onefile = F)
#set parameters
plot.new()
# Add margins
par(oma=c(2,2,2,2))
# Add axes
plot.window(xlim= axis.x, ylim= axis.y)

#B. Plot maps for the base
plotRGB(hillshade, r = 1, g = 2, b = 3, interpolate = T , ext= ext, alpha = 255, bgalpha =0, stretch="lin", bty="7", axes = F, yaxs='r', xaxs='r') #stretch "lin" or "hist" are contrast and alpha (0 to 255) is brightness
plotRGB(landcover2,r=1, g=2, b=3, interpolate=T, ext= ext, alpha =120, bgalpha =0, stretch="lin", bty="7", axes = F, yaxs='r', xaxs='r', add=T) #stretch "lin" or "hist" are contrast and alpha (0 to 255) is brightness
plotRGB(landcover3,r=1, g=2, b=3, interpolate=T, ext= ext, alpha =100, bgalpha =0, stretch="lin", bty="7", axes = F, yaxs='r', xaxs='r', add=T) #stretch "lin" or "hist" are contrast and alpha (0 to 255) is brightness
plot(cangas, add=TRUE, axes = F, bg = FALSE, bty ="n", xaxt='n', ann=FALSE, yaxt='n', lwd=1, col = "beige")

#C. Plot long and lat axes:
axis(1, at=seq(-50.7, -49.7, by=0.2),  cex.axis=1, pos=-6.5)
axis(2, at=seq(-6.5, -5.8, by=0.2),  cex.axis=1, las=1, pos=-50.7)

#D. Plot the pies charts:
#set population names and colors. SAME THAN STEP 2!
legend_tess
col_tess
#plot the pies. Z must be a matrix! Radius is the size of pies!
names(df) #verify number of cols with ancestry information
draw.pie(z=as.matrix(df[18:22]), x=df$longitude, y=df$latitude, radius = 0.02, col=col_tess, labels="")

#E. Plot the names of Serras in Carajás or any area names according to shapefile information
posi_names_serra = which(!is.na(cangas$Serra2))
lon_names_serra = coordinates(cangas)[,1][posi_names_serra]
lat_names_serra = coordinates(cangas)[,2][posi_names_serra]
#plot names:
shadowtext((lon_names_serra-0.08), (lat_names_serra-0.025), cangas$Serra2[posi_names_serra], col="black", bg="white", cex=0.9, r=0.1)

#F. Plot the names of localities according to vcf information in metafile
localities = df$local_ID
for (i in 1:length(localities)){
  #pick the position of the first sample from that localities
  posi_local = which(df$local_ID %in% localities[i] == TRUE)[1]
  shadowtext((df$longitude[posi_local]+0.0), (df$latitude[posi_local]+0.0), localities[i], col="black", bg="white", cex=0.65, r=0.08, pos=4)
}
  
#G. Plot the legend:
legend(x=-49.85, y=-5.85, legend = legend_tess, cex = 0.8, bty="o", bg = "white", box.col="black",  col = "black", pt.bg = col_tess, pch= 21, pt.cex=1.5)
  
#H. Plot the scale bar:
scalebar(10, xy=c(-50.65,-6.47), type="bar", lonlat = T, below = "Km", label = c(0,5,10), adj=c(0,-1.5), cex = 0.7)
  
#I. Plot a north arrow:
north.arrow(xb=-49.8, yb=-6.45, len=0.015, cex.lab=0.8, lab="N", col='black', font.sub=1)
  
#J. Turn off pdf:
dev.off()
```